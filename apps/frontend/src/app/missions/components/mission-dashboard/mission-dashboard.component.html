<div class="mission-dashboard-container">
  <!-- Header Section -->
  <div class="mission-dashboard-header">
    <h1 class="mission-dashboard-title">Mission Packs</h1>
  </div>

  <!-- Loading State -->
  @if (loading) {
  <div class="mission-dashboard-loading">
    <div class="loading-spinner"></div>
    <h3>Loading missions...</h3>
  </div>
  }

  <!-- Error State -->
  @if (error && !loading) {
  <div class="mission-dashboard-error">
    <div class="error-icon">‚ö†Ô∏è</div>
    <h3>Error loading missions</h3>
    <p class="error-message">{{ error }}</p>
    <button (click)="loadMissions()" class="retry-button">Try Again</button>
  </div>
  }

  <!-- No Missions State -->
  @if (!loading && !error && missions.length === 0) {
  <div class="mission-dashboard-empty">
    <div class="empty-icon">üìã</div>
    <h3>No missions</h3>
    <p>Get started by creating a new mission in the admin panel.</p>
  </div>
  }

  <!-- Missions Grid - 3 per row -->
  @if (!loading && !error && missions.length > 0) {
  <div class="mission-dashboard-grid">
    @for (mission of missions; track trackByMissionSlug($index, mission)) {
    <app-mission-card
      [mission]="mission"
      [showDescription]="true"
      [showGames]="true"
      [showPlayButton]="true"
      (playMission)="onPlayMission($event)"
    >
    </app-mission-card>
    }
  </div>
  }

  <!-- Players Score Management Section -->
  @if (!loading && !error && missions.length > 0) {
  <div class="players-score-section">
    <h2 class="section-title">Player Scores Management</h2>
    <p class="section-subtitle">Update scores for players in each mission</p>

    @if (loadingPlayers) {
    <div class="loading-players">
      <div class="loading-spinner"></div>
      <p>Loading players...</p>
    </div>
    } @else {
    @for (missionWithPlayers of missionsWithPlayers; track missionWithPlayers.mission.slug) {
    <mat-card class="mission-players-card">
      <div class="mission-header">
        <h3 class="mission-name">{{ missionWithPlayers.mission.name }}</h3>
        <span class="player-count">{{ missionWithPlayers.players.length }} player(s)</span>
      </div>

      @if (missionWithPlayers.loading) {
      <div class="loading-players-inline">
        <div class="loading-spinner-small"></div>
        <span>Loading players...</span>
      </div>
      } @else if (missionWithPlayers.players.length === 0) {
      <div class="no-players">
        <mat-icon>people_outline</mat-icon>
        <p>No players have joined this mission yet.</p>
      </div>
      } @else {
      <table mat-table [dataSource]="missionWithPlayers.players" class="players-table">
        <!-- Player Column -->
        <ng-container matColumnDef="player">
          <th mat-header-cell *matHeaderCellDef>Player</th>
          <td mat-cell *matCellDef="let player">
            <div class="player-info">
              @if (player.avatar_url) {
              <img [src]="player.avatar_url" [alt]="player.username" class="player-avatar" />
              } @else {
              <div class="player-avatar-fallback">
                {{ player.username.charAt(0).toUpperCase() }}
              </div>
              }
              <div class="player-details">
                <span class="player-username">{{ player.username }}</span>
                <span class="player-email">{{ player.email }}</span>
              </div>
            </div>
          </td>
        </ng-container>

        <!-- Score Column -->
        <ng-container matColumnDef="score">
          <th mat-header-cell *matHeaderCellDef>Score</th>
          <td mat-cell *matCellDef="let player">
            <mat-form-field appearance="outline" class="score-input">
              <input
                matInput
                type="number"
                [value]="player.score ?? ''"
                (blur)="updateScore(missionWithPlayers.mission.slug, player.player_id, parseInteger($any($event.target).value))"
                placeholder="Enter score"
                min="0"
                step="1"
              />
            </mat-form-field>
          </td>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let player">
            <button
              mat-icon-button
              color="warn"
              (click)="clearScore(missionWithPlayers.mission.slug, player.player_id)"
              matTooltip="Clear score"
              class="clear-button"
            >
              <mat-icon>clear</mat-icon>
            </button>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
      </table>
      }
    </mat-card>
    }
    }
  </div>
  }
</div>
