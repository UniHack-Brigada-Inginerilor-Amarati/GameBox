<div class="mission-page-container">
  <!-- Loading State -->
  @if (isLoading) {
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <h3>Loading mission...</h3>
    </div>
  }

  <!-- Mission Content -->
  @if (!isLoading && mission) {
    <!-- Header Section -->
    <div class="mission-header">
      <button 
        mat-icon-button 
        class="back-button"
        (click)="goBack()"
        aria-label="Go back"
      >
        <mat-icon>arrow_back</mat-icon>
      </button>
      
      <div class="mission-title-section">
        <h1 class="mission-title">{{ mission.name }}</h1>
        <p class="mission-description">{{ getDescriptionText(mission.description) }}</p>
      </div>
    </div>


    <!-- Players Section -->
    <div class="players-section">
      <h2 class="section-title">Players</h2>
      <p class="section-subtitle">Players who have joined this mission</p>
      
      @if (isLoadingPlayers) {
      <div class="loading-players">
        <div class="loading-spinner"></div>
        <p>Loading players...</p>
      </div>
      } @else if (players.length === 0) {
      <div class="no-players">
        <mat-icon>people_outline</mat-icon>
        <p>No players have joined this mission yet.</p>
      </div>
      } @else {
      <mat-card class="players-card">
        <table mat-table [dataSource]="players" class="players-table">
          <!-- Player Column -->
          <ng-container matColumnDef="player">
            <th mat-header-cell *matHeaderCellDef>Player</th>
            <td mat-cell *matCellDef="let player">
              <div class="player-info">
                @if (player.avatar_url) {
                <img [src]="player.avatar_url" [alt]="player.username" class="player-avatar" />
                } @else {
                <div class="player-avatar-fallback">
                  {{ player.username.charAt(0).toUpperCase() }}
                </div>
                }
                <div class="player-details">
                  <span class="player-username">{{ player.username }}</span>
                  <span class="player-email">{{ player.email }}</span>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Mental Fortitude / Composure Score Column -->
          <ng-container matColumnDef="mental_fortitude_composure_score">
            <th mat-header-cell *matHeaderCellDef>Mental Fortitude / Composure</th>
            <td mat-cell *matCellDef="let player">
              <mat-form-field appearance="outline" class="score-input">
                <input
                  matInput
                  type="number"
                  [value]="player.mental_fortitude_composure_score ?? ''"
                  (blur)="updateAbilityScore(player.player_id, 'mental_fortitude_composure_score', parseInteger($any($event.target).value))"
                  placeholder="-"
                  min="0"
                  step="1"
                />
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Adaptability / Decision Making Score Column -->
          <ng-container matColumnDef="adaptability_decision_making_score">
            <th mat-header-cell *matHeaderCellDef>Adaptability / Decision Making</th>
            <td mat-cell *matCellDef="let player">
              <mat-form-field appearance="outline" class="score-input">
                <input
                  matInput
                  type="number"
                  [value]="player.adaptability_decision_making_score ?? ''"
                  (blur)="updateAbilityScore(player.player_id, 'adaptability_decision_making_score', parseInteger($any($event.target).value))"
                  placeholder="-"
                  min="0"
                  step="1"
                />
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Aim / Mechanical Skill Score Column -->
          <ng-container matColumnDef="aim_mechanical_skill_score">
            <th mat-header-cell *matHeaderCellDef>Aim / Mechanical Skill</th>
            <td mat-cell *matCellDef="let player">
              <mat-form-field appearance="outline" class="score-input">
                <input
                  matInput
                  type="number"
                  [value]="player.aim_mechanical_skill_score ?? ''"
                  (blur)="updateAbilityScore(player.player_id, 'aim_mechanical_skill_score', parseInteger($any($event.target).value))"
                  placeholder="-"
                  min="0"
                  step="1"
                />
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Game Sense / Awareness Score Column -->
          <ng-container matColumnDef="game_sense_awareness_score">
            <th mat-header-cell *matHeaderCellDef>Game Sense / Awareness</th>
            <td mat-cell *matCellDef="let player">
              <mat-form-field appearance="outline" class="score-input">
                <input
                  matInput
                  type="number"
                  [value]="player.game_sense_awareness_score ?? ''"
                  (blur)="updateAbilityScore(player.player_id, 'game_sense_awareness_score', parseInteger($any($event.target).value))"
                  placeholder="-"
                  min="0"
                  step="1"
                />
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Teamwork / Communication Score Column -->
          <ng-container matColumnDef="teamwork_communication_score">
            <th mat-header-cell *matHeaderCellDef>Teamwork / Communication</th>
            <td mat-cell *matCellDef="let player">
              <mat-form-field appearance="outline" class="score-input">
                <input
                  matInput
                  type="number"
                  [value]="player.teamwork_communication_score ?? ''"
                  (blur)="updateAbilityScore(player.player_id, 'teamwork_communication_score', parseInteger($any($event.target).value))"
                  placeholder="-"
                  min="0"
                  step="1"
                />
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Strategy Score Column -->
          <ng-container matColumnDef="strategy_score">
            <th mat-header-cell *matHeaderCellDef>Strategy</th>
            <td mat-cell *matCellDef="let player">
              <mat-form-field appearance="outline" class="score-input">
                <input
                  matInput
                  type="number"
                  [value]="player.strategy_score ?? ''"
                  (blur)="updateAbilityScore(player.player_id, 'strategy_score', parseInteger($any($event.target).value))"
                  placeholder="-"
                  min="0"
                  step="1"
                />
              </mat-form-field>
            </td>
          </ng-container>

          <!-- State Column -->
          <ng-container matColumnDef="state">
            <th mat-header-cell *matHeaderCellDef>State</th>
            <td mat-cell *matCellDef="let player">
              <span class="state-badge" [class.playing]="player.state === 'playing'" [class.completed]="player.state === 'completed'">
                {{ player.state === 'playing' ? 'Is playing' : (player.state === 'completed' ? 'Completed' : '-') }}
              </span>
            </td>
          </ng-container>

          <!-- Overall Score Column -->
          <ng-container matColumnDef="score">
            <th mat-header-cell *matHeaderCellDef>Overall Score</th>
            <td mat-cell *matCellDef="let player">
              <mat-form-field appearance="outline" class="score-input">
                <input
                  matInput
                  type="number"
                  [value]="player.score ?? ''"
                  (blur)="updateScore(player.player_id, parseInteger($any($event.target).value))"
                  placeholder="Enter score"
                  min="0"
                  step="1"
                  style="color: #f5f5f5;"
                />
              </mat-form-field>
            </td>
          </ng-container>

          <!-- Joined Column -->
          <ng-container matColumnDef="joined">
            <th mat-header-cell *matHeaderCellDef>Joined</th>
            <td mat-cell *matCellDef="let player">
              <span class="joined-date">{{ formatDate(player.created_at) }}</span>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Actions</th>
            <td mat-cell *matCellDef="let player">
              <button
                mat-icon-button
                color="warn"
                (click)="clearScore(player.player_id)"
                matTooltip="Clear score"
                class="clear-button"
              >
                <mat-icon>clear</mat-icon>
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
      </mat-card>
      }
    </div>

    <!-- Games Grid -->
    <div class="games-section">
      <h2 class="games-title">Mission Games</h2>
      <p class="games-subtitle">Complete all games to finish this mission</p>
      
      <div class="games-grid">
        <!-- Mental Fortitude / Composure Game -->
        @if (mission.games.mentalFortitudeComposure) {
        <app-game-card 
          [game]="getGameForCard(mission.games.mentalFortitudeComposure, 'Mental Fortitude / Composure')!"
        ></app-game-card>
        }

        <!-- Adaptability / Decision Making Game -->
        @if (mission.games.adaptabilityDecisionMaking) {
        <app-game-card 
          [game]="getGameForCard(mission.games.adaptabilityDecisionMaking, 'Adaptability / Decision Making')!"
        ></app-game-card>
        }

        <!-- Aim / Mechanical Skill Game -->
        @if (mission.games.aimMechanicalSkill) {
        <app-game-card 
          [game]="getGameForCard(mission.games.aimMechanicalSkill, 'Aim / Mechanical Skill')!"
        ></app-game-card>
        }

        <!-- Game Sense / Awareness Game -->
        @if (mission.games.gameSenseAwareness) {
        <app-game-card 
          [game]="getGameForCard(mission.games.gameSenseAwareness, 'Game Sense / Awareness')!"
        ></app-game-card>
        }

        <!-- Teamwork / Communication Game -->
        @if (mission.games.teamworkCommunication) {
        <app-game-card 
          [game]="getGameForCard(mission.games.teamworkCommunication, 'Teamwork / Communication')!"
        ></app-game-card>
        }

        <!-- Strategy Game -->
        @if (mission.games.strategy) {
        <app-game-card 
          [game]="getGameForCard(mission.games.strategy, 'Strategy')!"
        ></app-game-card>
        }
      </div>
    </div>
  }

  <!-- Error State -->
  @if (!isLoading && !mission) {
    <div class="error-state">
      <mat-icon class="error-icon">error</mat-icon>
      <h3>Mission Not Found</h3>
      <p>The requested mission could not be loaded.</p>
      <button 
        mat-raised-button 
        color="primary"
        (click)="goBack()"
      >
        Go Back
      </button>
    </div>
  }
</div>
