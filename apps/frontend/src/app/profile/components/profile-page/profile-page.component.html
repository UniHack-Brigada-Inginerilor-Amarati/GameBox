<div class="profile-container">
  <mat-card class="profile-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>person</mat-icon>
        Profile
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      @if (isLoading()) {
      <div class="loading-state">
        <div class="loading-skeleton">
          <div class="skeleton-avatar"></div>
          <div class="skeleton-content">
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
            <div class="skeleton-line"></div>
          </div>
        </div>
      </div>
      } @else if (user()) {
      <div class="profile-info">
        <!-- Avatar Section -->
        <div class="avatar-section">
          <img
            [src]="user()?.avatar_url"
            [alt]="user()?.username"
            class="avatar-image"
            (error)="onImageError()"
          />
          @if (!isEditing()) {
          <button
            mat-fab
            color="primary"
            class="edit-profile-btn"
            (click)="startEditing()"
            matTooltip="Edit Profile"
            aria-label="Edit Profile"
          >
            <mat-icon>edit</mat-icon>
          </button>
          }
        </div>

        <!-- Debug info (remove in production) -->
        <div style="font-size: 12px; color: #666; margin-top: 10px"></div>

        @if (isEditing()) {
        <!-- Edit Form -->
        <div class="edit-form">
          <!-- Error Alert -->
          @if (error()) {
          <div class="error-alert">
            <mat-icon>error</mat-icon>
            <span>{{ error() }}</span>
          </div>
          }

          <!-- Username Edit Section -->
          <div class="edit-section">
            <div class="edit-header">
              <mat-icon>person</mat-icon>
              <span>Edit Username</span>
            </div>
            <div class="edit-content">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Username</mat-label>
                <input
                  matInput
                  [(ngModel)]="editUsername"
                  (ngModelChange)="onUsernameChange()"
                  placeholder="Enter your username"
                />
                @if (usernameError()) {
                <mat-error>{{ usernameError() }}</mat-error>
                }
              </mat-form-field>
            </div>
          </div>

          <!-- Avatar Upload Section -->
          <div class="edit-section">
            <div class="edit-header">
              <mat-icon>photo_camera</mat-icon>
              <span>Change Avatar</span>
            </div>

            <div class="edit-content">
              @if (!selectedFile) {
              <div
                class="upload-area"
                (click)="triggerFileInput()"
                (keydown.enter)="triggerFileInput()"
                (keydown.space)="triggerFileInput()"
                tabindex="0"
                role="button"
                aria-label="Select avatar image"
              >
                <mat-icon>add_photo_alternate</mat-icon>
                <p>Click to select an image</p>
                <span class="upload-hint">JPG, PNG, WEBP, GIF up to 5MB</span>
              </div>
              } @else {
              <!-- File Preview -->
              <div class="file-preview">
                <div class="preview-image">
                  <img [src]="previewUrl" [alt]="selectedFile.name" />
                </div>
                <div class="file-details">
                  <div class="file-name">{{ selectedFile.name }}</div>
                  <div class="file-size">{{ formatFileSize(selectedFile.size) }}</div>
                </div>
                <div class="file-actions">
                  <button mat-icon-button (click)="clearSelectedFile()" class="clear-btn">
                    <mat-icon>close</mat-icon>
                  </button>
                  <button
                    mat-raised-button
                    color="primary"
                    (click)="uploadAvatar()"
                    [disabled]="isSaving()"
                    class="upload-btn"
                  >
                    <mat-icon>cloud_upload</mat-icon>
                    {{ isSaving() ? 'Uploading...' : 'Upload Avatar' }}
                  </button>
                </div>
              </div>
              }
            </div>

            <input
              #fileInput
              type="file"
              accept="image/*"
              (change)="onFileSelected($event)"
              style="display: none"
            />
          </div>

          <!-- Avatar URL Section -->
          <div class="edit-section">
            <div class="edit-header">
              <mat-icon>link</mat-icon>
              <span>Avatar URL</span>
            </div>
            <div class="edit-content">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Avatar URL</mat-label>
                <input matInput [(ngModel)]="editAvatarUrl" placeholder="Enter avatar URL" />
                <button
                  mat-icon-button
                  matSuffix
                  (click)="generateAvatar()"
                  [disabled]="isSaving()"
                >
                  <mat-icon>refresh</mat-icon>
                </button>
              </mat-form-field>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <button
              mat-raised-button
              color="primary"
              (click)="saveProfile()"
              [disabled]="isSaving()"
            >
              <mat-icon>save</mat-icon>
              {{ isSaving() ? 'Saving...' : 'Save Changes' }}
            </button>
            <button mat-button (click)="cancelEditing()" [disabled]="isSaving()">Cancel</button>
          </div>
        </div>
        } @else {
        <!-- Display Info -->
        <div class="info-section">
          <div class="info-row">
            <mat-icon>person</mat-icon>
            <div class="info-content">
              <div class="info-label">Username</div>
              <span>{{ user()?.username }}</span>
            </div>
          </div>

          <div class="info-row">
            <mat-icon>email</mat-icon>
            <div class="info-content">
              <div class="info-label">Email Address</div>
              <span>{{ user()?.email }}</span>
            </div>
          </div>

          <div class="info-row">
            <mat-icon>calendar_today</mat-icon>
            <div class="info-content">
              <div class="info-label">Member Since</div>
              <span>{{ user()?.created_at | date : 'mediumDate' }}</span>
            </div>
          </div>
        </div>
        }
      </div>
      } @else {
      <div class="no-data-state">
        <mat-icon>person_off</mat-icon>
        <p>No profile data available</p>
      </div>
      }

      <!-- Navigation Buttons -->
      <div class="navigation-section">
        <h3>Quick Actions</h3>
        <div class="nav-buttons">
          <button mat-raised-button color="primary" routerLink="/dashboard" class="nav-btn">
            <mat-icon>dashboard</mat-icon>
            Dashboard
          </button>
          <button mat-raised-button color="accent" routerLink="/reservation/new" class="nav-btn">
            <mat-icon>add</mat-icon>
            Make Reservation
          </button>
          <button mat-stroked-button routerLink="/my-reservations" class="nav-btn">
            <mat-icon>event</mat-icon>
            My Reservations
          </button>
        </div>
      </div>

      <!-- Logout Button -->
      <app-logout></app-logout>

      <!-- Go back to landing page button -->
      <div class="landing-button-container"></div>
    </mat-card-content>
  </mat-card>
</div>
