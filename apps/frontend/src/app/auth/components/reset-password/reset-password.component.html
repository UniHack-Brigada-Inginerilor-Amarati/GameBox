<div class="auth-wrapper">
  <div class="auth-card">
    @if (tokenInvalid()) {
      <!-- Invalid Token State -->
      <div class="error-state">
        <div class="error-icon">
          <mat-icon>error</mat-icon>
        </div>
        <h2 class="auth-title">Invalid or Expired Link</h2>
        <p class="auth-subtitle">
          This password reset link is invalid or has expired. Please request a new one.
        </p>
        
        <div class="form-actions">
          <button 
            mat-raised-button 
            color="primary" 
            routerLink="/auth/forgot-password"
          > 
            <mat-icon>refresh</mat-icon>
            Request New Link
          </button>
        </div>
      </div>
    } @else if (passwordReset()) {
      <!-- Success State -->
      <div class="success-state">
        <div class="success-icon">
          <mat-icon>check_circle</mat-icon>
        </div>
        <h2 class="auth-title">Password Reset Successfully</h2>
        <p class="auth-subtitle">
          Your password has been updated. You can now log in with your new password.
        </p>
        
        <div class="form-actions">
          <button 
            mat-raised-button 
            color="primary" 
            (click)="goToLogin()"
          >
            <mat-icon>login</mat-icon>
            Back to Login
          </button>
        </div>
      </div>
    } @else {
      <!-- Reset Password Form -->
      <h2 class="auth-title">Reset your password</h2>
      <p class="auth-subtitle">Enter your new password below</p>

      <form [formGroup]="resetPasswordForm" (ngSubmit)="onSubmit()" class="auth-form">
        <!-- New Password Field -->
        <mat-form-field appearance="fill">
          <mat-label>New Password</mat-label>
          <input
            matInput
            [type]="showPassword() ? 'text' : 'password'"
            formControlName="password"
            placeholder="••••••••"
          />

          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="togglePasswordVisibility()"
            [attr.aria-label]="'Toggle password visibility'"
            [attr.aria-pressed]="showPassword()"
          >
            <mat-icon>{{ showPassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>

          @if (password.invalid && (password.touched || submitted())) {
            @for (error of passwordErrors; track error) {
              <mat-error>{{ error }}</mat-error>
            }
          }
        </mat-form-field>

        <!-- Confirm Password Field -->
        <mat-form-field appearance="fill">
          <mat-label>Confirm New Password</mat-label>
          <input
            matInput
            [type]="showConfirmPassword() ? 'text' : 'password'"
            formControlName="confirmPassword"
            placeholder="••••••••"
          />

          <button
            mat-icon-button
            matSuffix
            type="button"
            (click)="toggleConfirmPasswordVisibility()"
            [attr.aria-label]="'Toggle confirm password visibility'"
            [attr.aria-pressed]="showConfirmPassword()"
          >
            <mat-icon>{{ showConfirmPassword() ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>

          @if ((confirmPassword.invalid || resetPasswordForm.hasError('fieldsMismatch')) && (confirmPassword.touched || submitted())) {
            @for (error of confirmPasswordErrors; track error) {
              <mat-error>{{ error }}</mat-error>
            }
          }
        </mat-form-field>

        <!-- Submit Button -->
        <button 
          mat-raised-button 
          color="primary" 
          type="submit"
        >
          @if (isLoading()) {
            Resetting...
          } @else if (resetPasswordForm.invalid) {
            Reset Password
          } @else {
            Reset Password
          }

          @if (isLoading()) {
            <mat-icon>hourglass_empty</mat-icon>
          }
          @else if (resetPasswordForm.invalid) {
            <mat-icon>block</mat-icon>
          }
          @else {
            <mat-icon>lock_reset</mat-icon>
          }
        </button>
      </form>
    }

    <!-- Navigation Links -->
    @if (!tokenInvalid() && !passwordReset()) {
      <p class="auth-link-text">
        Remember your password?
        <a routerLink="/auth/login">Back to login</a>
      </p>
    }
  </div>
</div>
